---
title: 'Final Project: Is Your College Worthy? (Tuition VS Salary)'
author: "Junjie Yang"
date: "5/2/2020"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# Call out packages that needed for the project
library(ggplot2)
library(repurrrsive)
library(tidyverse)
library(stringr)
library(dplyr)
library(tidytext)
library(wordcloud)
library(broom)
library(readxl)  
library(lubridate)
library(magrittr)
library(rvest)
library(xml2)
library(choroplethr)
library(choroplethrMaps)
library(countrycode)
library("xlsx")
```



```{r include=FALSE}
salary_potential <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/salary_potential.csv')

historical_tuition <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/historical_tuition.csv')


#Housing Data

state_hpi <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/state_hpi.csv")

mortgage_rates <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/mortgage.csv")

```

## Import first data: 
First data source, tuition_cost, is from "College tuition, Diversity, and Pay" in rfordatascience/tidetuesday/2020-03-10, which is originally acquired from the US Department of Education and the Chronicle of Higher Education. 

```{r include=FALSE}
tuition_cost <-read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/tuition_cost.csv')

```

## Data Cleaning for tuition_cost data
In the tuition_cost data, relevant columns are selected (name of the school, state, state code, type of the school, length of the degree). Also, room and board fee and tuition are combined as total tuition and fee.
```{r echo=FALSE}

tuition_cost = tuition_cost%>%
  select(name, state, state_code, type, degree_length, in_state_total, out_of_state_total)%>%
  mutate(in_state_tuition_and_fee = in_state_total, out_of_state_tuition_and_fee = out_of_state_total, in_state_total = NULL, out_of_state_total = NULL)
```

## Below is the snippet of tuition_cost data
```{r echo=TRUE}
head(tuition_cost,10)
```


## Import second data: 
Second data source, student_diversity by college/university, along with school type, degree length, state, in-state vs out-of-state is from the Chronicle of Higher Education.
```{r include=FALSE}
student_diversity <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/student_diversity.csv')
```

## Data Cleaning for student_diversity data
In the student_diversity data, the main data cleansing task is to modify name of institution to match the “name” column and “state” column in the tuition_cost data, in order to combine dataset. Several data wrangling steps were applied. First is to change the column name “INSTITUTION” to “name”. After that, convert any abbreviation of University from “U.” to “University”. From the first glance, the name of state is located at the very end of the name of institution. The next step is to extract state from school name with the help of state.name which contains the list of all the state name and column “state” is created. Last but not least, state name inside the name of institution needed to remove. Using str_count to count the letters within state in each observation and str_sub help to keep the name of school only in the “name” column. Str_trim and str_squish are used to remove unnecessary spaces in "name".
```{r include=FALSE}
#Select relevant columns and change column name "INSTITUTION" to “name” to later binding datasets
student_diversity = student_diversity%>%
  rename(name = "INSTITUTION")%>%
  select(name, ENROLLMENT:WHITE, `TOTAL MINORITY` )

#Modify school name to match school name in the tuition_cost data 
student_diversity_cleaned = student_diversity%>%
  mutate(name = str_replace(name, "U.", "University "))

#Extract state from school name with the help of state.name which contains the list of all the state name
student_diversity_cleaned = student_diversity_cleaned%>%
  mutate(state = str_extract(name, paste0(state.name, collapse = "|")))

#Clear any unnecessary spaces in "name" and remove the state at the end of "name"
student_diversity_cleaned$name = str_squish(student_diversity_cleaned$name)

position_to_remove = str_count(student_diversity_cleaned$state)+1
student_diversity_cleaned$name = str_sub(student_diversity_cleaned$name, 1, -(position_to_remove))

student_diversity_cleaned$name = str_trim(student_diversity_cleaned$name)
```

## Below is the snippet of student_diversity_cleaned data
```{r echo=TRUE}
head(student_diversity_cleaned,10)
```

## Combine tuition_cost and student_diversity data based on "name" and "state"
So far, student_diversity and tuition_cost are modified to share two common column, “name” – name of the school and “state” – the state that the school is located. Thus, student_diversity and tuition_cost datasets are merged for late development. There are a few schools appears in the tuition_cost dataset but not in the student_diversity and “NA” value appear. It is reasonable and schools with “NA” value are removed from the combined dataset. The combined dataset is arranged by state and the name of the school.
```{r include=FALSE}
tuition_with_diversity = left_join(tuition_cost, student_diversity_cleaned, by = c("name","state"))%>%
  na.omit(tuition_with_diversity)

tuition_with_diversity = tuition_with_diversity[order(tuition_with_diversity$state, tuition_with_diversity$name),]
```

## Below is the snippet of tuition_with_diversity data
```{r echo=TRUE}
head(tuition_with_diversity,10)
```

## Import third data: Best_School
Third data source, best_school is html data, acquired from the from the payscale.com. It contains all the schools in United States that are arranged by various measurement of career performance, such as "Early Career Pay" and "Mid Career Pay.

## Problem encountered
When importing html data from https://www.payscale.com/college-salary-report/bachelors, I realized the table only include the data with the top 25 schools in the United States, descending by measurement of career performance. That's the issue that I am not expecting. Moreover, this is the first page in the web and there are 63 pages in total, which consists all the school data.
```{r include=FALSE}
#Initial datapull
url <- ("https://www.payscale.com/college-salary-report/bachelors")

best_school_test = url %>% 
  read_html() %>% 
  html_table(fill = TRUE) %>% 
  .[[1]]
```

## Problem resolved
Instead of importing data 63 times to get the entire dataset, one alternative webpage is found by navigating the payscale.com. The page “Best Schools By State” (https://www.payscale.com/college-salary-report/best-schools-by-state) outlays all the best schools ranked by measurement of career performance of all 50 states. Clicking on each state would direct to the schools data within that particular state. In order to import the entire data, I first convert the string format in the list of state.name to match the url (“New York” to “New-York”). Then, a data frame is created. For-Loop is implemented to import all 50 states data to the R environment and to keep loading data into the data frame to form a complete dataset, “Best_School”, for data cleansing.

```{r echo=FALSE}
store_url = "https://www.payscale.com/college-salary-report/best-schools-by-state/bachelors/"

#Modify state in state.name to match the format in url
state_name = str_replace_all(state.name, " ","-")

#Initial dataframe to start with
Best_School = best_school_test

#Keep appending data to dataframe
for (i in 1:length(state_name)){
  url = paste0(store_url,state_name[i])
  school_state_data = paste0("Best_School",i)
  
  school_state_data = url %>% 
    read_html() %>% 
    html_table(fill = TRUE) %>% 
    .[[1]]
  
  Best_School = rbind(Best_School, school_state_data)
}

#Remove rows in initial dataframe
Best_School = Best_School[-(1:25),]
```


## Data Cleaning for Best_School data
First step is to modify the column name "School Name" to "name" and to keep the exact name of school only, in order to match the tuition_with_diversity dataset for binding. After that, there are several data cleansing steps that are applied to other columns. Only numeric values are extracted from the column, “Rank”, "Early Career Pay", "Mid-Career Pay", "% High Meaning", "% STEM Degrees". One lesson learned is that R suggests to use parse_number(), instead of extract_numeric() for extracting numeric value.

 
```{r include=FALSE}
#Modify "School Name" to "name" to match the tuition_with_diversity dataset
Best_School_clean = Best_School%>%
  rename(name = "School Name")

#Extract school name
Best_School_clean$name = str_remove(Best_School_clean$name, "School Name:")

Best_School_clean$`Mid-Career Pay` = str_remove(Best_School_clean$`Mid-Career Pay`, "Mid-Career Pay:")

#Extract number content from certain column  
Best_School_clean = Best_School_clean%>%
  mutate(
  Rank = parse_number(Best_School_clean$Rank),
  "Early Career Pay" = parse_number(Best_School_clean$`Early Career Pay`),
  "Mid-Career Pay" = parse_number(Best_School_clean$`Mid-Career Pay`),
  "% High Meaning" = parse_number(Best_School_clean$`% High Meaning`),
  "% STEM Degrees" = parse_number(Best_School_clean$`% STEM Degrees`),
  )

Best_School_clean = Best_School_clean%>%
  select(name, "Early Career Pay", "Mid-Career Pay", "% High Meaning", "% STEM Degrees" )
```

## Below is the snippet of Best_School_clean data
```{r echo=TRUE}
head(Best_School_clean,10)
```

## Combine Best_School_clean data and tuition_with_diversity
Finally, Best_School_clean data, which contains different measurements of career performance, merges with tuition_with_diversity data, which contains detailed school information including tuition and race. The column both datasets have in common is “name” and left_join is performed. Similar to the previous merged dataset, schools with “NA” are removed from the dataset. 
```{r include=FALSE}
Fianl_data = left_join(Best_School_clean, tuition_with_diversity, by = "name") %>%
  na.omit(Fianl_data)
rownames(Fianl_data)=1:nrow(Fianl_data)
```

## Below is the snippet of the Final_data with 622 observations in all 50 states in United States and each college or university is a unique observation. This is the tidy version of the final data and it will be stored as a csv file.
```{r echo=TRUE}
head(Fianl_data,10)
```
## The tidy version of the final data is saved under local location and will be committed from Github desktop to Github.com repository (https://github.com/Junjie-Dylan-Yang/Data-Wrangling-Project)
```{r include=FALSE}
getwd()
write.xlsx(Fianl_data, "Tidy_Data.xlsx", row.names = FALSE)
```


































